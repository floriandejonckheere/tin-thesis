\chapter{Data model}
\label{ch:data-model}

In this section we describe the conceptual domain of this research, and provide a logical data model that fits the domain.
For every NoSQL data model selected, we also propose a physical data model.
This data model will then be implemented in a Ruby on Rails application using the available language bindings.
Finally, a set of reference queries will be proposed, queries that may typically be used in the context of the Recent Activity feed.

\section{Domain description}
\label{sec:domain-description}

On the Open Webslides platform, there is technically no distinction between a teacher's and a student's account.
Both of them are represented by the \texttt{User} entity in the database.
This entity contains information pertaining to the user, such as email address, first name and last name.
The data models described in the next sections will closely follow the existing data model of the platform.
However, certain irrelevant attributes are omitted from the model in order to improve readability and simplify abstraction.

A user can create or modify course content in an interactive online editor.
The actual course content, formally called a topic, is stored inside a git repository on the filesystem.
However, the platform also maintains a record of topic metadata in the relational database.
This metadata includes title and description, but also permissions and contributors on the course content.
Per illustration, the \texttt{title} and \texttt{description} attributes are included in the data models.

From a technological perspective, the user has three distinct paths of action for (co-)creation on course content.
Since the permission model in the platform is not relevant to this research, we will not go into detail on it.
First, the user can directly modify the course content if the user has permission to do so.
The second option is creating annotations on the topic.
This allows the user to attach private or public notes to specific content on the topic.
Annotations are stored in the relational database, mapped to the \texttt{Annotation} entity.
The entity contains a logical pointer to the annotated content, which is omitted from the data models.
The final possibility to integrate user content into a topic is by adding comments.
In contrast to annotations, comments have a typical structure.
They can take the form of questions, notes, suggestions, and can also be nested - which allows simple interaction and conversation between multiple users, and effectively enables dialogue between students and teachers.

The intention of this thesis is to use the NoSQL data storage as storage mechanism for the Recent Activity feed.
This entails that the authoritative information will not be stored in that data store, but rather be extracted from the relational database whenever an activity event is generated.
Accordingly, some information may be omitted from this data store, while other information is copied.

Consider the following domain description structured as activity events in the Recent Activity feed.

``
\textbf{John} created \textbf{Topic A}.
''

``
\textbf{Jane} commented on \textbf{Topic B}:
\textit{This is not a good example. Try and find a better one.}
''

``
\textbf{John} commented on \textbf{Jane}'s comment on \textbf{Topic B}:
\textit{I agree.}
''

``
\textbf{Jane} annotated \textbf{Topic A}.
''

``
\textbf{Bob} reacted to \textbf{John}'s comment on \textbf{Topic B}.
''

Using this description of the domain, we can start to derive logical and physical data models for the selected NoSQL data stores.

% Typical usage of data is important: write once, no update, read many queried reverse chronologically

\section{Physical data model}
\label{sec:physical-data-model}

\subsection{Document-oriented data model}
\label{subsec:document-data-model}

% References (normalized) vs embedded collections (denormalized)
  % Normalized: when read performance outweighs data duplication, hierarchical data sets
  % Denormalized: "contains" relationship, one-to-many
% Document growth: small documents
% Atomicity on write document level: atomic dependencies stored in same document
% Sharding: on date?
% Indexes: inexpensive because write once
% Data expiration/TTL: can't use

% Capped collections

\subsection{Column-oriented data model}
\label{subsec:column-data-model}

\subsection{Graph-oriented data model}
\label{subsec:graph-data-model}

Using the examples of activity events in \cref{sec:domain-description}, we can identify the components used in database graph model.
The first entity that is identified are the \textit{nodes}

%% Nodes

% User, Annotation, Topic, Comment

%% Labels

% Subject, Object

%% Relations

% Event
% Comment->User, Comment->Topic due to the nodes inherent referent nature


From the domain description, we can derive the labels, nodes and relationships to build the graph data model.
The first entities that are identified are the nodes.
In the domain, we have four main entities.

\begin{itemize}
  \item \texttt{User}
  \item \texttt{Topic}
  \item \texttt{Comment}
  \item \texttt{Annotation}
\end{itemize}

In order for the Recent Activity feed to string all this together, there is also an entity to represent an activity event called \texttt{Event}.
\texttt{Event}s have relationships to all other entities according to the (subject, predicate, object)-triple explained in \cref{sec:logical-data-model}.

% Labels
Neoj data modeling supports something called \textit{Labels}, a graph construct that groups nodes into sets.
A set contains nodes with the same label.
A node can have any number of labels.

In the domain model, we can distinguish one case where labels are very useful.
The \textit{object} of the event triple can be one of multiple entities, in this thesis the scope is restricted to \texttt{Topic}, \texttt{Comment} and \texttt{Annotation}.
Using this label abstraction allows future expansion with more object entity types.
Consequently, we propose the label \texttt{Object} which aggregates nodes of these types.
To keep the naming in the data model consistent, the lable \texttt{Subject} will also be applied to nodes of the type \texttt{User}.

% Relationships
We can identify the following interactions between the entities:

\begin{itemize}
  \item A \texttt{User} is the author of many \texttt{Topic}s
  \item A \texttt{Topic} has many \texttt{Comment}s attached to it
  \item A \texttt{Topic} has many \texttt{Annotation}s attached to it
  \item Both \texttt{Comment}s and \texttt{Annotation}s are created by a \texttt{User}
  \item A \texttt{Comment} optionally has many children comments
\end{itemize}

Additionally, the \texttt{Event} entity introduces the following interactions:

\begin{itemize}
  \item An \texttt{Event} relates to a \texttt{User} (the subject)
  \item An \texttt{Event} relates to an object
\end{itemize}

This leads us to the graph model in figure \ref{fig:graph-model}.

\section{Reference queries}
\label{sec:reference-queries}

% Example queries on the data model

% Select the N most recent events, ordered reverse chronologically
% Insert event "User X created Topic Y"
% Insert event "User X reacted to User Y's comment on Topic Z"
